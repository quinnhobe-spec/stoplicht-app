<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Stoplicht - dashboard</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:20px}
h2{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
}
h2 button{
    font-size:20px;
    padding:4px 8px;
    cursor:pointer;
    border:none;
    border-radius:4px;
    background:#007bff;
    color:white;
}
.student{
    padding:12px;
    margin:8px 0;
    border-radius:8px;
    color:white;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
}
.student small{font-size:12px;opacity:0.9;}
.aanhetwerk{background:#5cb85c}
.vraag{background:#d9534f}
button{margin-left:8px}
.delete-btn{
    background:none;
    border:none;
    color:white;
    font-size:16px;
    margin-left:8px;
    cursor:pointer;
}
</style>
</head>
<body>
<h2>
    Stoplicht - dashboard
    <button id="addStudentBtn">âž• Voeg leerling toe</button>
</h2>
<div id="list" class="loading">Ladenâ€¦</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8wWU5VUq6YLNzxBObFuVN8WYegKzZTPI",
  authDomain: "stoplichtblokje.firebaseapp.com",
  databaseURL: "https://stoplichtblokje-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "stoplichtblokje",
  storageBucket: "stoplichtblokje.firebasestorage.app",
  messagingSenderId: "1019644227104",
  appId: "1:1019644227104:web:833b07ad778a8df5171645",
  measurementId: "G-3MG6YRBVD2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const listEl = document.getElementById('list');
const STATUSES = ['aanhetwerk','vraag'];

// Render dashboard
function render(items){
    listEl.innerHTML='';
    if(items.length===0){listEl.textContent='Geen studenten gevonden.'; return;}

    // Sorteer: eerst 'vraag' op volgorde van eerste klik, dan rest
    items.sort((a,b)=>{
        if(a.status==='vraag' && b.status!=='vraag') return -1;
        if(a.status!=='vraag' && b.status==='vraag') return 1;
        if(a.status==='vraag' && b.status==='vraag') return (a.vraagTijd||0)-(b.vraagTijd||0);
        return 0;
    });

    items.forEach(it=>{
        const div=document.createElement('div');
        const status = STATUSES.includes(it.status) ? it.status : 'aanhetwerk';
        div.className='student '+status;

        const left=document.createElement('div');
        const name=document.createElement('div');
        name.textContent=it.name;
        left.appendChild(name);

        const right=document.createElement('div');
        const statusLabel=document.createElement('small');
        statusLabel.textContent=status==='aanhetwerk'?'Aan het werk':'Heeft een vraag';
        right.appendChild(statusLabel);

        const btn=document.createElement('button');
        btn.textContent='Verander status';
        btn.addEventListener('click', ev=>{ev.stopPropagation(); cycleStatus(it.id);});
        right.appendChild(btn);

        const delBtn=document.createElement('button');
        delBtn.className='delete-btn';
        delBtn.textContent='ðŸ—‘ï¸';
        delBtn.title='Verwijder leerling';
        delBtn.addEventListener('click', ev=>{
            ev.stopPropagation();
            if(confirm('Weet je zeker dat je deze leerling wilt verwijderen?')){
                db.ref('students/'+it.id).remove();
            }
        });
        right.appendChild(delBtn);

        div.appendChild(left); div.appendChild(right);
        div.addEventListener('click', ()=>cycleStatus(it.id));
        listEl.appendChild(div);
    });
}

// Cycle status
function cycleStatus(id){
    const ref=db.ref('students/'+id+'/status');
    ref.once('value').then(snap=>{
        const cur = snap.val();
        const idx = STATUSES.indexOf(cur);
        const next = STATUSES[(idx+1)%STATUSES.length]||STATUSES[0];
        const updates = {status: next};
        if(next==='vraag' && !snap.val().vraagTijd) updates.vraagTijd = Date.now();
        if(next!=='vraag') updates.vraagTijd=null;
        db.ref('students/'+id).update(updates);
    });
}

// Realtime updates
db.ref('students').on('value', snapshot=>{
    const val = snapshot.val()||{};
    const arr = Object.keys(val).map(k=>({
        id:k,
        name:val[k].name,
        status:val[k].status||'aanhetwerk',
        vraagTijd:val[k].vraagTijd||null
    }));
    render(arr);
});

// Voeg leerling toe
document.getElementById('addStudentBtn').addEventListener('click', ()=>{
    const naam = prompt('Voer de naam van de nieuwe leerling in:');
    if(naam && naam.trim()!==''){
        const id = naam.toLowerCase().replace(/\s+/g,'_');
        db.ref('students/'+id).set({
            name: naam.trim(),
            status: 'aanhetwerk',
            vraagTijd: null
        });
    }
});
</script>
</body>
</html>
